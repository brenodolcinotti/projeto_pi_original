<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dep√≥sito - Manuten√ß√£o | SLA Sistema de Log√≠stica e Armazenamento</title>
    <link rel="stylesheet" href="../style/deposit.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header id="main-header" class="maintenance-mode">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon maintenance" id="logo-icon">SLA</div>
                    <h1>Sistema de <span>Log√≠stica e Armazenamento</span></h1>
                </div>
                <div class="user-info maintenance" id="user-info">
                    <span id="user-name">T√©cnico</span>
                    <span class="user-type maintenance" id="user-type-display">Manuten√ß√£o</span>
                    <a href="login.html" class="btn btn-danger" id="logout-btn" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                        <i class="fas fa-sign-out-alt"></i>
                        Sair
                    </a>
                </div>
            </div>
        </div>
    </header>

    <section class="page">
        <div class="container">
            <!-- Dashboard do T√©cnico de Manuten√ß√£o -->
            <div class="maintenance-dashboard" id="maintenance-dashboard">
                <div class="dashboard-header">
                    <div class="welcome-message">
                        <h2 id="welcome-maintenance">Bem-vindo, T√©cnico de Manuten√ß√£o!</h2>
                        <p>Painel de Controle de Manuten√ß√£o</p>
                        <div id="server-status" class="server-status checking">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Verificando conex√£o com o servidor...</span>
                        </div>
                    </div>
                </div>

                <div class="maintenance-controls">
                    <button class="maintenance-control-btn active" id="maintenance-btn-registrar" onclick="switchMaintenanceSection('registrar')">
                        <i class="fas fa-clipboard-check"></i>
                        Registrar Manuten√ß√£o
                    </button>
                    <button class="maintenance-control-btn" id="maintenance-btn-historico" onclick="switchMaintenanceSection('historico')">
                        <i class="fas fa-history"></i>
                        Hist√≥rico
                    </button>
                    <button class="maintenance-control-btn" id="maintenance-btn-pendentes" onclick="switchMaintenanceSection('pendentes')">
                        <i class="fas fa-clock"></i>
                        Pendentes
                    </button>
                </div>

                <!-- SE√á√ÉO DE REGISTRAR MANUTEN√á√ÉO (COM M√âTRICAS) -->
                <div class="maintenance-section active" id="maintenance-section-registrar">
                    <!-- M√âTRICAS -->
                    <div class="maintenance-metrics">
                        <div class="maintenance-metric-card">
                            <div class="maintenance-metric-header">
                                <div class="maintenance-metric-icon">
                                    <i class="fas fa-tools"></i>
                                </div>
                            </div>
                            <div class="maintenance-metric-value" id="manutencao-pendente">0</div>
                            <div class="maintenance-metric-label">Manuten√ß√µes Pendentes</div>
                        </div>
                        <div class="maintenance-metric-card">
                            <div class="maintenance-metric-header">
                                <div class="maintenance-metric-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                            <div class="maintenance-metric-value" id="manutencao-concluida">0</div>
                            <div class="maintenance-metric-label">Manuten√ß√µes Conclu√≠das</div>
                        </div>
                    </div>

                    <!-- FORMUL√ÅRIO DE REGISTRO -->
                    <div class="card maintenance-card">
                        <h2 class="card-title maintenance-title">Registrar Manuten√ß√£o Conclu√≠da</h2>
                        <div id="form-alert" class="alert" style="display: none; margin-bottom: 20px;">
                            <!-- Alerta din√¢mico ser√° inserido aqui -->
                        </div>
                       
                        <form id="maintenance-register-form">
                            <div class="transaction-form">
                                <div class="form-group">
                                    <label for="maintenance-os-number">Item</label>
                                    <div class="input-with-icon">
                                        <i class="input-icon fas fa-hashtag"></i>
                                        <input type="text" id="maintenance-os-number" placeholder="Digite o item arrumado" required>
                                    </div>
                                </div>
                               
                                <div class="form-group">
                                    <label for="maintenance-type">Tipo de Manuten√ß√£o</label>
                                    <div class="input-with-icon">
                                        <i class="input-icon fas fa-wrench"></i>
                                        <select id="maintenance-type" required>
                                            <option value="Preventiva">Preventiva</option>
                                            <option value="Corretiva">Corretiva</option>
                                            <option value="Preditiva">Preditiva</option>
                                        </select>
                                    </div>
                                </div>
                               
                                <div class="form-group">
                                    <label for="maintenance-date">Data da Manuten√ß√£o</label>
                                    <div class="input-with-icon">
                                        <i class="input-icon fas fa-calendar-alt"></i>
                                        <input type="date" id="maintenance-date" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="maintenance-technician">T√©cnico Respons√°vel</label>
                                    <div class="input-with-icon">
                                        <i class="input-icon fas fa-user"></i>
                                        <input type="text" id="maintenance-technician" placeholder="Nome do t√©cnico" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="maintenance-duration">Dura√ß√£o (minutos)</label>
                                    <div class="input-with-icon">
                                        <i class="input-icon fas fa-clock"></i>
                                        <input type="number" id="maintenance-duration" placeholder="Ex: 65 minutos" required>
                                    </div>
                                </div>

                                <div class="form-group full-width">
                                    <label for="maintenance-problem">Observa√ß√µes</label>
                                    <div class="input-with-icon">
                                        <i class="input-icon fas fa-search"></i>
                                        <textarea id="maintenance-problem" rows="2" placeholder="Descreva o problema encontrado ou a solu√ß√£o aplicada"></textarea>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="maintenance-status">Setor</label>
                                    <div class="input-with-icon">
                                        <i class="input-icon fas fa-flag"></i>
                                        <select id="maintenance-status" required>
                                            <option value="RH">RH</option>
                                            <option value="Almoxarifado">Almoxarifado</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                           
                            <button type="submit" class="btn btn-block btn-success" id="submit-btn">
                                <i class="fas fa-save"></i>
                                <span id="submit-btn-text">Registrar Manuten√ß√£o</span>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- SE√á√ÉO DE HIST√ìRICO -->
                <div class="maintenance-section" id="maintenance-section-historico">
                    <div class="card maintenance-card">
                        <h2 class="card-title maintenance-title">Hist√≥rico de Manuten√ß√µes</h2>
                        <div id="historico-alert" class="alert" style="display: none; margin-bottom: 20px;">
                            <!-- Alerta din√¢mico ser√° inserido aqui -->
                        </div>
                        
                        <div class="table-responsive">
                            <table class="advanced-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Item</th>
                                        <th>Respons√°vel</th>
                                        <th>Data</th>
                                        <th>Setor</th>
                                        <th>Observa√ß√£o</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="maintenance-history-body">
                                    <!-- Dados ser√£o preenchidos dinamicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SE√á√ÉO DE PENDENTES -->
                <div class="maintenance-section" id="maintenance-section-pendentes">
                    <div class="card maintenance-card">
                        <h2 class="card-title maintenance-title">Manuten√ß√µes Pendentes</h2>
                        <div id="pendentes-alert" class="alert" style="display: none; margin-bottom: 20px;">
                            <!-- Alerta din√¢mico ser√° inserido aqui -->
                        </div>
                    
                        <div class="table-responsive">
                            <table class="advanced-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Item</th>
                                        <th>Solicitante</th>
                                        <th>Data Solicita√ß√£o</th>
                                        <th>Setor</th>
                                        <th>Problema</th>
                                        <th>Prioridade</th>
                                    </tr>
                                </thead>
                                <tbody id="maintenance-pending-body">
                                    <!-- Dados ser√£o preenchidos dinamicamente -->
                                </tbody>
                            </table>
                        </div> 
                    </div>
                </div>
            </div>
        </div>
    </section>
    <script src="../../Back-End/back/manutencao.js"></script>

    <style>
        .server-status {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        .server-status.checking {
            background-color: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }
        
        .server-status.online {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .server-status.offline {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .server-status i {
            margin-right: 5px;
        }
        
        .alert {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .alert i {
            margin-right: 10px;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
    </style>

    <script>
        // Sistema que detecta automaticamente se est√° online ou offline
        const STORAGE_KEY = 'sla_manutencao_data';
        let serverOnline = false;
        let simulationData = null;

        // Fun√ß√£o para testar se o servidor est√° online
        async function testarConexaoServidor() {
            const serverStatus = document.getElementById('server-status');
            
            try {
                // Primeiro tenta uma requisi√ß√£o simples
                const teste = await fetch('http://localhost:1111/', { 
                    method: 'GET',
                    mode: 'no-cors'
                }).catch(() => null);
                
                // Se chegou aqui sem erro, o servidor pode estar online
                // Vamos tentar uma requisi√ß√£o real para a API de manuten√ß√£o
                const response = await fetch('http://localhost:1111/manutencao', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                }).catch(() => null);
                
                if (response && response.ok) {
                    serverOnline = true;
                    if (serverStatus) {
                        serverStatus.className = 'server-status online';
                        serverStatus.innerHTML = '<i class="fas fa-check-circle"></i><span>Servidor Online</span>';
                    }
                    console.log('‚úÖ Servidor est√° online');
                    
                    // Se estava em modo simula√ß√£o, tentar sincronizar dados
                    if (simulationData && simulationData.historico.length > 0) {
                        sincronizarDadosComServidor();
                    }
                    
                } else {
                    throw new Error('Servidor n√£o respondeu corretamente');
                }
                
            } catch (error) {
                serverOnline = false;
                if (serverStatus) {
                    serverStatus.className = 'server-status offline';
                    serverStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Servidor Offline - Modo Simula√ß√£o</span>';
                }
                console.log('‚ö†Ô∏è Servidor offline, usando modo simula√ß√£o');
            }
            
            // Atualizar interface com base no status
            atualizarInterfaceModoOperacao();
        }

        // Fun√ß√£o para atualizar interface baseada no modo de opera√ß√£o
        function atualizarInterfaceModoOperacao() {
            const formAlert = document.getElementById('form-alert');
            const submitBtn = document.getElementById('submit-btn-text');
            const historicoAlert = document.getElementById('historico-alert');
            const pendentesAlert = document.getElementById('pendentes-alert');
            
            if (serverOnline) {
                // Modo online
                if (formAlert) {
                    formAlert.style.display = 'none';
                }
                if (submitBtn) {
                    submitBtn.textContent = 'Registrar Manuten√ß√£o';
                }
                if (historicoAlert) {
                    historicoAlert.style.display = 'none';
                }
                if (pendentesAlert) {
                    pendentesAlert.style.display = 'none';
                }
            } else {
                // Modo offline/simula√ß√£o
                if (formAlert) {
                    formAlert.className = 'alert alert-warning';
                    formAlert.innerHTML = '<i class="fas fa-exclamation-triangle"></i><strong>Modo Simula√ß√£o:</strong> Os dados ser√£o salvos localmente. Quando o servidor voltar, eles ser√£o sincronizados.';
                    formAlert.style.display = 'flex';
                }
                if (submitBtn) {
                    submitBtn.textContent = 'Registrar (Modo Simula√ß√£o)';
                }
                if (historicoAlert) {
                    historicoAlert.className = 'alert alert-info';
                    historicoAlert.innerHTML = '<i class="fas fa-info-circle"></i><strong>Modo Simula√ß√£o:</strong> Exibindo dados armazenados localmente.';
                    historicoAlert.style.display = 'flex';
                }
                if (pendentesAlert) {
                    pendentesAlert.className = 'alert alert-info';
                    pendentesAlert.innerHTML = '<i class="fas fa-info-circle"></i><strong>Modo Simula√ß√£o:</strong> Exibindo dados armazenados localmente.';
                    pendentesAlert.style.display = 'flex';
                }
            }
        }

        // Carregar dados do localStorage
        function carregarDadosSimulados() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    simulationData = JSON.parse(savedData);
                    console.log('Dados simulados carregados:', simulationData);
                } else {
                    // Dados iniciais de exemplo
                    simulationData = {
                        historico: [],
                        pendentes: [],
                        proximoId: 1,
                        lastUpdate: new Date().toISOString()
                    };
                    salvarDadosSimulados();
                }
            } catch (error) {
                console.error('Erro ao carregar dados simulados:', error);
                simulationData = {
                    historico: [],
                    pendentes: [],
                    proximoId: 1,
                    lastUpdate: new Date().toISOString()
                };
            }
        }

        // Salvar dados no localStorage
        function salvarDadosSimulados() {
            try {
                if (simulationData) {
                    simulationData.lastUpdate = new Date().toISOString();
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(simulationData));
                }
            } catch (error) {
                console.error('Erro ao salvar dados simulados:', error);
            }
        }

        // Fun√ß√£o para alternar entre se√ß√µes
        function switchMaintenanceSection(sectionId) {
            // Remover classe active de todos os bot√µes
            document.querySelectorAll('.maintenance-control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Remover classe active de todas as se√ß√µes
            document.querySelectorAll('.maintenance-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Adicionar classe active ao bot√£o clicado
            const btn = document.getElementById(`maintenance-btn-${sectionId}`);
            if (btn) btn.classList.add('active');
            
            // Adicionar classe active √† se√ß√£o correspondente
            const section = document.getElementById(`maintenance-section-${sectionId}`);
            if (section) section.classList.add('active');
            
            // Carregar dados da se√ß√£o
            if (sectionId === 'historico') {
                if (serverOnline) {
                    carregarHistoricoServidor();
                } else {
                    carregarHistoricoSimulado();
                }
            } else if (sectionId === 'pendentes') {
                if (serverOnline) {
                    carregarPendentesServidor();
                } else {
                    carregarPendentesSimulados();
                }
            } else if (sectionId === 'registrar') {
                atualizarMetricas();
                // Limpar formul√°rio quando abrir
                const form = document.getElementById('maintenance-register-form');
                if (form) {
                    form.reset();
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('maintenance-date').value = today;
                }
            }
        }

        // Atualizar m√©tricas
        function atualizarMetricas() {
            if (serverOnline) {
                // Se o servidor estiver online, tenta buscar dados reais
                // (voc√™ precisar√° implementar esta fun√ß√£o no seu backend)
                if (typeof buscarDados === 'function') {
                    buscarDados();
                }
            } else {
                // Modo simula√ß√£o
                const pendentesCount = simulationData ? simulationData.pendentes.length : 0;
                const concluidasCount = simulationData ? simulationData.historico.length : 0;
                
                document.getElementById('manutencao-pendente').textContent = pendentesCount;
                document.getElementById('manutencao-concluida').textContent = concluidasCount;
            }
        }

        // Carregar hist√≥rico do servidor (quando online)
        async function carregarHistoricoServidor() {
            const tbody = document.getElementById('maintenance-history-body');
            if (!tbody) return;
            
            tbody.innerHTML = '<tr><td colspan="7" class="text-center"><i class="fas fa-spinner fa-spin"></i> Carregando do servidor...</td></tr>';
            
            try {
                const response = await fetch('http://localhost:1111/nova-solicitacao?status=CONCLUIDA');
                if (response.ok) {
                    const dados = await response.json();
                    preencherTabelaHistorico(dados);
                } else {
                    throw new Error('Erro ao carregar hist√≥rico');
                }
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico do servidor:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar dados do servidor</td></tr>';
            }
        }

        // Carregar hist√≥rico simulado (quando offline)
        function carregarHistoricoSimulado() {
            const tbody = document.getElementById('maintenance-history-body');
            if (!tbody || !simulationData) return;
            
            tbody.innerHTML = '';
            
            if (simulationData.historico.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="fas fa-inbox"></i> Nenhuma manuten√ß√£o registrada
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Ordenar por data (mais recente primeiro)
            const historicoOrdenado = [...simulationData.historico].sort((a, b) => 
                new Date(b.data) - new Date(a.data)
            );
            
            historicoOrdenado.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.item}</td>
                    <td>${item.responsavel}</td>
                    <td>${formatarData(item.data)}</td>
                    <td>${item.setor}</td>
                    <td>${item.observacao || '-'}</td>
                    <td><span class="status-badge status-low">Conclu√≠da</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Carregar pendentes do servidor (quando online)
        async function carregarPendentesServidor() {
            const tbody = document.getElementById('maintenance-pending-body');
            if (!tbody) return;
            
            tbody.innerHTML = '<tr><td colspan="7" class="text-center"><i class="fas fa-spinner fa-spin"></i> Carregando do servidor...</td></tr>';
            
            try {
                const response = await fetch('http://localhost:1111/nova-solicitacao?status=PENDENTE');
                if (response.ok) {
                    const dados = await response.json();
                    preencherTabelaPendentes(dados);
                } else {
                    throw new Error('Erro ao carregar pendentes');
                }
            } catch (error) {
                console.error('Erro ao carregar pendentes do servidor:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar dados do servidor</td></tr>';
            }
        }

        // Carregar pendentes simulados (quando offline)
        function carregarPendentesSimulados() {
            const tbody = document.getElementById('maintenance-pending-body');
            if (!tbody || !simulationData) return;
            
            tbody.innerHTML = '';
            
            if (simulationData.pendentes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="fas fa-check-circle" style="color: #28a745;"></i> 
                            Nenhuma manuten√ß√£o pendente
                        </td>
                    </tr>
                `;
                return;
            }
            
            simulationData.pendentes.forEach(item => {
                const row = document.createElement('tr');
                const prioridadeClass = item.prioridade === 'Alta' ? 'status-high' : 
                                      item.prioridade === 'M√©dia' ? 'status-medium' : 'status-low';
                
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.item}</td>
                    <td>${item.solicitante || 'N/A'}</td>
                    <td>${formatarData(item.data_solicitacao)}</td>
                    <td>${item.setor}</td>
                    <td>${item.problema || '-'}</td>
                    <td><span class="status-badge ${prioridadeClass}">${item.prioridade || 'M√©dia'}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Fun√ß√µes auxiliares para preencher tabelas
        function preencherTabelaHistorico(dados) {
            const tbody = document.getElementById('maintenance-history-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (!dados || dados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="fas fa-inbox"></i> Nenhuma manuten√ß√£o registrada
                        </td>
                    </tr>
                `;
                return;
            }
            
            dados.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.id || 'N/A'}</td>
                    <td>${item.item || 'N/A'}</td>
                    <td>${item.resposavel || item.responsavel || 'N/A'}</td>
                    <td>${formatarData(item.data_solicitacao)}</td>
                    <td>${item.setor || 'N/A'}</td>
                    <td>${item.observacao || '-'}</td>
                    <td><span class="status-badge status-low">${item.status || 'Conclu√≠da'}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function preencherTabelaPendentes(dados) {
            const tbody = document.getElementById('maintenance-pending-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (!dados || dados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="fas fa-check-circle" style="color: #28a745;"></i> 
                            Nenhuma manuten√ß√£o pendente
                        </td>
                    </tr>
                `;
                return;
            }
            
            dados.forEach(item => {
                const row = document.createElement('tr');
                const prioridadeClass = 'status-high'; // Ou l√≥gica para determinar prioridade
                
                row.innerHTML = `
                    <td>${item.id || 'N/A'}</td>
                    <td>${item.item || 'N/A'}</td>
                    <td>${item.resposavel || item.responsavel || 'N/A'}</td>
                    <td>${formatarData(item.data_solicitacao)}</td>
                    <td>${item.setor || 'N/A'}</td>
                    <td>${item.observacao || item.problema || '-'}</td>
                    <td><span class="status-badge ${prioridadeClass}">Pendente</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Fun√ß√£o para formatar data
        function formatarData(dataString) {
            if (!dataString) return '-';
            try {
                const data = new Date(dataString);
                if (isNaN(data.getTime())) return dataString;
                return data.toLocaleDateString('pt-BR');
            } catch (e) {
                return dataString;
            }
        }

        // Registrar manuten√ß√£o (tenta servidor primeiro, depois simula√ß√£o)
        async function registrarManutencao(dados) {
            if (serverOnline) {
                // Tentar enviar para o servidor
                try {
                    const response = await fetch("http://localhost:1111/manutencao", {
                        method: "POST",
                        headers: { 
                            "Content-Type": "application/json" 
                        },
                        body: JSON.stringify(dados)
                    });
                    
                    if (response.ok) {
                        const resultado = await response.json();
                        return { success: true, data: resultado, mode: 'server' };
                    } else {
                        throw new Error('Erro ao enviar para servidor');
                    }
                } catch (error) {
                    console.log('Falha ao enviar para servidor, salvando localmente:', error);
                    // Cai no modo simula√ß√£o
                }
            }
            
            // Modo simula√ß√£o
            if (!simulationData) carregarDadosSimulados();
            
            const id = 'SIM-' + simulationData.proximoId.toString().padStart(3, '0');
            simulationData.proximoId++;
            
            const novaManutencao = {
                id: id,
                item: dados.item,
                responsavel: dados.responsavel,
                data: dados.data_manutencao,
                setor: dados.setor,
                observacao: dados.observacao,
                tipo: dados.tipo,
                tempo_manutencao: dados.tempo_manutencao,
                status: 'CONCLUIDA'
            };
            
            simulationData.historico.unshift(novaManutencao);
            salvarDadosSimulados();
            
            return { success: true, data: novaManutencao, mode: 'simulation' };
        }

        // Sincronizar dados com servidor quando voltar online
        async function sincronizarDadosComServidor() {
            if (!serverOnline || !simulationData) return;
            
            console.log('Tentando sincronizar dados com servidor...');
            
            // Aqui voc√™ pode implementar a l√≥gica para enviar dados do localStorage para o servidor
            // quando a conex√£o for restaurada
        }

        // Inicializar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('P√°gina de manuten√ß√£o carregada');
            
            // Carregar dados simulados
            carregarDadosSimulados();
            
            // Configurar data atual
            const today = new Date().toISOString().split('T')[0];
            const dateField = document.getElementById('maintenance-date');
            if (dateField) dateField.value = today;
            
            // Configurar o formul√°rio
            const form = document.getElementById('maintenance-register-form');
            const submitBtn = document.getElementById('submit-btn');
            
            if (form && submitBtn) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Desabilitar bot√£o temporariamente
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
                    submitBtn.disabled = true;
                    
                    try {
                        // Coletar dados do formul√°rio
                        const dados = {
                            item: document.getElementById('maintenance-os-number').value.trim(),
                            tipo: document.getElementById('maintenance-type').value,
                            data_manutencao: document.getElementById('maintenance-date').value,
                            responsavel: document.getElementById('maintenance-technician').value.trim(),
                            tempo_manutencao: document.getElementById('maintenance-duration').value,
                            observacao: document.getElementById('maintenance-problem').value.trim(),
                            setor: document.getElementById('maintenance-status').value
                        };
                        
                        // Valida√ß√£o
                        if (!dados.responsavel) {
                            alert("‚ö†Ô∏è Preencha o campo T√©cnico Respons√°vel");
                            document.getElementById("maintenance-technician").focus();
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                            return;
                        }
                        
                        if (!dados.item || !dados.tempo_manutencao) {
                            alert("‚ö†Ô∏è Preencha todos os campos obrigat√≥rios!");
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                            return;
                        }
                        
                        // Registrar manuten√ß√£o
                        const resultado = await registrarManutencao(dados);
                        
                        if (resultado.success) {
                            let mensagem = `‚úÖ Manuten√ß√£o registrada com sucesso!\n\nID: ${resultado.data.id}\nItem: ${resultado.data.item}\nT√©cnico: ${resultado.data.responsavel}`;
                            
                            if (resultado.mode === 'simulation') {
                                mensagem += '\n\nüíæ Os dados foram salvos localmente. Quando o servidor voltar, eles ser√£o sincronizados.';
                            }
                            
                            alert(mensagem);
                            
                            // Limpar formul√°rio
                            form.reset();
                            document.getElementById('maintenance-date').value = today;
                            
                            // Atualizar m√©tricas
                            atualizarMetricas();
                            
                            // Se estiver na se√ß√£o de hist√≥rico, atualizar
                            if (document.getElementById('maintenance-section-historico').classList.contains('active')) {
                                if (serverOnline) {
                                    carregarHistoricoServidor();
                                } else {
                                    carregarHistoricoSimulado();
                                }
                            }
                            
                        } else {
                            throw new Error('Falha ao registrar manuten√ß√£o');
                        }
                        
                    } catch (error) {
                        console.error('Erro ao registrar manuten√ß√£o:', error);
                        alert('‚ùå Erro ao registrar manuten√ß√£o: ' + error.message);
                    } finally {
                        // Reativar bot√£o
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                });
            }
            
            // Configurar logout
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (confirm('Deseja realmente sair do sistema?')) {
                        window.location.href = 'login.html';
                    }
                });
            }
            
            // Testar conex√£o com servidor
            testarConexaoServidor();
            
            // Atualizar m√©tricas iniciais
            atualizarMetricas();
            
            // Verificar periodicamente se o servidor voltou
            setInterval(testarConexaoServidor, 30000); // A cada 30 segundos
        });
    </script>
</body>
</html>