<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depósito - Funcionário | SLA Sistema de Logística e Armazenamento</title>
    <link rel="stylesheet" href="../style/deposit.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <header id="main-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon" id="logo-icon">SLA</div>
                    <h1>Sistema de <span>Logística e Armazenamento</span></h1>
                </div>
                <div class="user-info" id="user-info">
                    <span id="user-name">Usuário</span>
                    <span class="user-type" id="user-type-display">Funcionário</span>
                    <a href="#" class="btn btn-danger" id="logout-btn" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                        <i class="fas fa-sign-out-alt"></i>
                        Sair
                    </a>
                </div>
            </div>
        </div>
    </header>

    <section class="page">
        <div class="container">
            <div class="employee-dashboard" id="employee-dashboard">
                <div class="dashboard-header">
                    <div class="welcome-message">
                        <h2 id="welcome-employee">Bem-vindo, Funcionário!</h2>
                        <p>Painel de Controle do Funcionário</p>
                    </div>
                </div>

                <div class="employee-controls">
                    <button class="employee-control-btn active" id="employee-btn-solicitacoes" onclick="switchEmployeeSection('solicitacoes')">
                        <i class="fas fa-file-alt"></i>
                        Solicitações
                    </button>
                    <button class="employee-control-btn" id="employee-btn-movimentacao" onclick="switchEmployeeSection('movimentacao')">
                        <i class="fas fa-exchange-alt"></i>
                        Movimentação
                    </button>
                    <button class="employee-control-btn" id="employee-btn-manutencao" onclick="switchEmployeeSection('manutencao')">
                        <i class="fas fa-tools"></i>
                        Manutenção
                    </button>
                </div>

                <!-- Seção de Solicitações -->
                <div class="employee-section active" id="employee-section-solicitacoes">
                    <div class="employee-metrics">
                        <!-- Solicitações Pendentes -->
                        <div class="employee-metric-card">
                            <div class="employee-metric-header">
                                <div class="employee-metric-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                            <div class="employee-metric-value" id="metric-pendentes"></div>
                            <div class="employee-metric-label">Solicitações Pendentes</div>
                        </div>

                        <!-- Solicitações Aprovadas -->
                        <div class="employee-metric-card">
                            <div class="employee-metric-header">
                                <div class="employee-metric-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                            <div class="employee-metric-value" id="metric-concluidas"></div>
                            <div class="employee-metric-label">Solicitações Concluídas</div>
                        </div>
                    </div>

                    <div class="card employee-card">
                        <h2 class="card-title employee-title">Minhas Solicitações Recentes</h2>
                        
                        <table class="advanced-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Data</th>
                                    <th>Material</th>
                                    <th>Quantidade</th>
                                    <th>Projeto</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>#SOL-2023-001</td>
                                    <td>15/10/2023</td>
                                    <td>Ferramentas</td>
                                    <td>5</td>
                                    <td>Manutenção Preventiva</td>
                                    <td><span class="badge badge-success">Aprovado</span></td>
                                    <td>
                                        <button class="btn btn-secondary" style="padding: 0.5rem;">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>#SOL-2023-002</td>
                                    <td>14/10/2023</td>
                                    <td>Componentes Eletrônicos</td>
                                    <td>10</td>
                                    <td>Reparo de Equipamentos</td>
                                    <td><span class="badge badge-warning">Em Análise</span></td>
                                    <td>
                                        <button class="btn btn-secondary" style="padding: 0.5rem;">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>#SOL-2023-003</td>
                                    <td>13/10/2023</td>
                                    <td>EPI - Luvas</td>
                                    <td>2</td>
                                    <td>Segurança do Trabalho</td>
                                    <td><span class="badge badge-danger">Rejeitado</span></td>
                                    <td>
                                        <button class="btn btn-secondary" style="padding: 0.5rem;">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Seção de Movimentação -->
                <div class="employee-section" id="employee-section-movimentacao">
                    <div class="employee-metrics">
                        <div class="employee-metric-card">
                            <div class="employee-metric-header">
                                <div class="employee-metric-icon">
                                    <i class="fas fa-arrow-down"></i>
                                </div>
                            </div>
                            <div class="employee-metric-value">12</div>
                            <div class="employee-metric-label">Entradas Este Mês</div>
                        </div>
                        <div class="employee-metric-card">
                            <div class="employee-metric-header">
                                <div class="employee-metric-icon">
                                    <i class="fas fa-arrow-up"></i>
                                </div>
                            </div>
                            <div class="employee-metric-value">8</div>
                            <div class="employee-metric-label">Saídas Este Mês</div>
                        </div>
                    </div>

                    <div class="card employee-card">
                        <h2 class="card-title employee-title">Movimentação de Materiais</h2>
                        
                        <div class="transaction-type">
                            <button class="btn active" id="employee-deposit-btn">
                                <i class="fas fa-boxes"></i>
                                <span>Entrada de Material</span>
                            </button>
                            <button class="btn btn-secondary" id="employee-withdrawal-btn">
                                <i class="fas fa-dolly"></i>
                                <span>Retirada de Material</span>
                            </button>
                        </div>
                        
                        <form id="employee-transaction-form">
                            <div class="transaction-form">
                                <div class="form-group">
                                    <label for="employee-transaction-material">Nome do Produto</label>
                                    <div class="input-with-icon">
                                        <i class="input-icon fas fa-box"></i>
                                        <input type="text" placeholder="Digite o nome do material" id="employee-transaction-name" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="employee-transaction-quantity">Quantidade</label>
                                    <div class="input-with-icon">
                                        <i class="input-icon fas fa-hashtag"></i>
                                        <input type="number" id="employee-transaction-quantity" min="1" placeholder="Digite a quantidade" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="employee-transaction-location">Localização</label>
                                    <div class="input-with-icon">
                                        <i class="input-icon fas fa-map-marker-alt"></i>
                                        <input type="text" placeholder="Digite seu setor" required id="employee-transaction-location">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="employee-transaction-date">Data</label>
                                    <div class="input-with-icon">
                                        <i class="input-icon fas fa-calendar-alt"></i>
                                        <input type="date" id="employee-transaction-date" required>
                                    </div>
                                </div>

                                <div class="form-group full-width">
                                    <label for="employee-transaction-notes">Observações</label>
                                    <div class="input-with-icon">
                                        <i class="input-icon fas fa-sticky-note"></i>
                                        <textarea id="employee-transaction-notes" rows="3" placeholder="Adicione observações se necessário"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-block btn-success" id="employee-transaction-submit-btn">
                                <i class="fas fa-check-circle"></i>
                                <span>Registrar Entrada</span>
                            </button>
                        </form>
                    </div>

                    <div class="card employee-card">
                        <h2 class="card-title employee-title">Minhas Movimentações Recentes</h2>
                        
                        <table class="advanced-table">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Tipo</th>
                                    <th>Material</th>
                                    <th>Quantidade</th>
                                    <th>Localização</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>15/10/2023 14:30</td>
                                    <td><span class="badge badge-success"><i class="fas fa-arrow-down"></i> Entrada</span></td>
                                    <td>Ferramentas</td>
                                    <td>5</td>
                                    <td>Almoxarifado A</td>
                                    <td><span class="status-badge status-low">Concluído</span></td>
                                </tr>
                                <tr>
                                    <td>15/10/2023 11:15</td>
                                    <td><span class="badge badge-danger"><i class="fas fa-arrow-up"></i> Saída</span></td>
                                    <td>Componentes Eletrônicos</td>
                                    <td>10</td>
                                    <td>Setor de Produção</td>
                                    <td><span class="status-badge status-high">Pendente</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Seção de Manutenção -->
                <div class="employee-section" id="employee-section-manutencao">
                    <div class="employee-metrics">
                        <div class="employee-metric-card">
                            <div class="employee-metric-header">
                                <div class="employee-metric-icon">
                                    <i class="fas fa-tools"></i>
                                </div>
                            </div>
                            <div class="employee-metric-value">5</div>
                            <div class="employee-metric-label">Solicitações de Manutenção</div>
                        </div>
                        <div class="employee-metric-card">
                            <div class="employee-metric-header">
                                <div class="employee-metric-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                            <div class="employee-metric-value">2</div>
                            <div class="employee-metric-label">Em Andamento</div>
                        </div>
                        <div class="employee-metric-card">
                            <div class="employee-metric-header">
                                <div class="employee-metric-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                            <div class="employee-metric-value">18</div>
                            <div class="employee-metric-label">Concluídas</div>
                        </div>
                    </div>

                    <div class="maintenance-grid">
                        <div class="maintenance-card">
                            <div class="maintenance-header">
                                <div class="maintenance-icon">
                                    <i class="fas fa-warehouse"></i>
                                </div>
                            </div>
                            <div class="maintenance-value">2</div>
                            <div class="maintenance-label">Equipamentos Críticos</div>
                            <div class="progress-bar">
                                <div class="progress-fill progress-high"></div>
                            </div>
                            <div class="employee-quick-actions">
                                <button class="employee-quick-action-btn" onclick="solicitarManutencao('Empilhadeira')">
                                    <i class="fas fa-wrench"></i> Solicitar
                                </button>
                            </div>
                        </div>

                        <div class="maintenance-card">
                            <div class="maintenance-header">
                                <div class="maintenance-icon">
                                    <i class="fas fa-truck"></i>
                                </div>
                            </div>
                            <div class="maintenance-value">3</div>
                            <div class="maintenance-label">Veículos em Manutenção</div>
                            <div class="progress-bar">
                                <div class="progress-fill progress-medium"></div>
                            </div>
                            <div class="employee-quick-actions">
                                <button class="employee-quick-action-btn" onclick="solicitarManutencao('Veículos')">
                                    <i class="fas fa-calendar"></i> Agendar
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card employee-card">
                        <h2 class="card-title employee-title">Minhas Solicitações de Manutenção</h2>
                        
                        <table class="advanced-table">
                            <thead>
                                <tr>
                                    <th>OS #</th>
                                    <th>Equipamento</th>
                                    <th>Tipo</th>
                                    <th>Data</th>
                                    <th>Prioridade</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>OS-2023-015</td>
                                    <td>Empilhadeira Elétrica</td>
                                    <td>Corretiva</td>
                                    <td>15/10/2023</td>
                                    <td><span class="badge badge-danger">Alta</span></td>
                                    <td><span class="status-badge status-high">Pendente</span></td>
                                </tr>
                                <tr>
                                    <td>OS-2023-014</td>
                                    <td>Esteira Transportadora</td>
                                    <td>Preventiva</td>
                                    <td>12/10/2023</td>
                                    <td><span class="badge badge-warning">Média</span></td>
                                    <td><span class="status-badge status-low">Concluído</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="card employee-card">
                        <h2 class="card-title employee-title">Nova Solicitação de Manutenção</h2>
                       
                        <form id="employee-maintenance-form">
                            <div class="transaction-form">
                                <div class="form-group">
                                    <label for="employee-maintenance-equipment">Equipamento</label>
                                    <div class="input-with-icon">
                                        <i class="input-icon fas fa-toolbox"></i>
                                        <select id="employee-maintenance-equipment" required>
                                            <option value="">Selecione o equipamento</option>
                                            <option value="empilhadeira">Empilhadeira Elétrica</option>
                                            <option value="esteira">Esteira Transportadora</option>
                                            <option value="refrigeracao">Sistema de Refrigeração</option>
                                            <option value="computador">Computador</option>
                                        </select>
                                    </div>
                                </div>
                               
                                <div class="form-group">
                                    <label for="employee-maintenance-type">Tipo de Manutenção</label>
                                    <div class="input-with-icon">
                                        <i class="input-icon fas fa-wrench"></i>
                                        <select id="employee-maintenance-type" required>
                                            <option value="preventiva">Preventiva</option>
                                            <option value="corretiva">Corretiva</option>
                                        </select>
                                    </div>
                                </div>
                               
                                <div class="form-group">
                                    <label for="employee-maintenance-priority">Prioridade</label>
                                    <div class="input-with-icon">
                                        <i class="input-icon fas fa-flag"></i>
                                        <select id="employee-maintenance-priority" required>
                                            <option value="baixa">Baixa</option>
                                            <option value="media">Média</option>
                                            <option value="alta">Alta</option>
                                        </select>
                                    </div>
                                </div>
                               
                                <div class="form-group full-width">
                                    <label for="employee-maintenance-description">Descrição do Problema</label>
                                    <div class="input-with-icon">
                                        <i class="input-icon fas fa-sticky-note"></i>
                                        <textarea id="employee-maintenance-description" rows="3" placeholder="Descreva o problema ou serviço necessário" required></textarea>
                                    </div>
                                </div>
                            </div>
                           
                            <button type="submit" class="btn btn-block btn-warning">
                                <i class="fas fa-tools"></i>
                                <span>Solicitar Manutenção</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Interface Básica do Funcionário (Fallback) -->
            <div class="employee-interface" id="employee-interface">
                <div class="card">
                    <h2 class="card-title">Interface do Funcionário</h2>
                    <p style="text-align: center; color: var(--text-secondary); margin-bottom: 2rem;">
                        Esta é a interface do funcionário. Faça login como gerente para acessar o dashboard administrativo.
                    </p>
                    <div style="text-align: center;">
                        <button class="btn btn-success" onclick="location.reload()">
                            <i class="fas fa-sync-alt"></i>
                            Recarregar Página
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="../../Back-End/back/deposit.js"></script>

    <script>
        // Função para alternar entre seções do funcionário
        function switchEmployeeSection(sectionId) {
            // Remover classe active de todos os botões
            document.querySelectorAll('.employee-control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Remover classe active de todas as seções
            document.querySelectorAll('.employee-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Adicionar classe active ao botão clicado
            document.getElementById(`employee-btn-${sectionId}`).classList.add('active');
            
            // Adicionar classe active à seção correspondente
            document.getElementById(`employee-section-${sectionId}`).classList.add('active');
        }

        // Função para solicitar manutenção
        function solicitarManutencao(equipamento) {
            alert(`Solicitação de manutenção para ${equipamento} enviada!`);
        }

        // Inicializar a página
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar data atual no campo de data
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('employee-transaction-date');
            if (dateInput) {
                dateInput.value = today;
            }
            
            // Mostrar dashboard do funcionário
            const employeeDashboard = document.getElementById('employee-dashboard');
            if (employeeDashboard) {
                employeeDashboard.style.display = 'block';
            }
            
            // Configurar evento de submit para o formulário de manutenção
            const maintenanceForm = document.getElementById('employee-maintenance-form');
            if (maintenanceForm) {
                maintenanceForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const equipment = document.getElementById('employee-maintenance-equipment').value;
                    const type = document.getElementById('employee-maintenance-type').value;
                    const priority = document.getElementById('employee-maintenance-priority').value;
                    const description = document.getElementById('employee-maintenance-description').value;
                    
                    alert(`Solicitação de manutenção enviada!\n\nEquipamento: ${equipment}\nTipo: ${type}\nPrioridade: ${priority}\nDescrição: ${description}`);
                    
                    // Limpar formulário
                    maintenanceForm.reset();
                });
            }
            
            // Configurar botões de tipo de transação
            const depositBtn = document.getElementById('employee-deposit-btn');
            const withdrawalBtn = document.getElementById('employee-withdrawal-btn');
            const submitBtn = document.getElementById('employee-transaction-submit-btn');
            
            if (depositBtn && withdrawalBtn && submitBtn) {
                depositBtn.addEventListener('click', function() {
                    depositBtn.classList.add('active');
                    withdrawalBtn.classList.remove('active');
                    submitBtn.innerHTML = '<i class="fas fa-check-circle"></i><span>Registrar Entrada</span>';
                    submitBtn.className = 'btn btn-block btn-success';
                });
                
                withdrawalBtn.addEventListener('click', function() {
                    withdrawalBtn.classList.add('active');
                    depositBtn.classList.remove('active');
                    submitBtn.innerHTML = '<i class="fas fa-check-circle"></i><span>Registrar Saída</span>';
                    submitBtn.className = 'btn btn-block btn-danger';
                });
            }
            
            // Configurar evento de submit para o formulário de transação COM CONEXÃO AO SEU BANCO
            const transactionForm = document.getElementById('employee-transaction-form');
            if (transactionForm) {
                transactionForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Salvar o texto original do botão
                    const submitBtn = document.getElementById('employee-transaction-submit-btn');
                    const originalBtnText = submitBtn.innerHTML;
                    const originalBtnDisabled = submitBtn.disabled;
                    
                    try {
                        // Desabilitar botão e mostrar loading
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
                        
                        // Determinar tipo de transação
                        const isDeposit = depositBtn.classList.contains('active');
                        const tipoTransacao = isDeposit ? 'entrada' : 'saida';
                        
                        // Coletar dados do formulário
                        const dados = {
                            nome_produto: document.getElementById('employee-transaction-name').value.trim(),
                            quantidade: parseInt(document.getElementById('employee-transaction-quantity').value),
                            setor: document.getElementById('employee-transaction-location').value.trim(),
                            data: document.getElementById('employee-transaction-date').value,
                            observacao: document.getElementById('employee-transaction-notes').value.trim(),
                            tipo: tipoTransacao
                        };
                        
                        // Validação
                        if (!dados.nome_produto || dados.quantidade <= 0 || !dados.setor || !dados.data) {
                            alert('Por favor, preencha todos os campos obrigatórios corretamente!');
                            return;
                        }
                        
                        console.log('Enviando dados:', dados);
                        
                        // Definir endpoint baseado no tipo de transação
                        let endpoint;
                        let dadosFormatados;
                        
                        if (isDeposit) {
                            endpoint = 'http://localhost:1111/entrada-estoque';
                            dadosFormatados = {
                                nome_produto: dados.nome_produto,
                                quantidade: dados.quantidade,
                                setor: dados.setor,
                                data_entrada: dados.data,
                                observacao: dados.observacao
                            };
                        } else {
                            endpoint = 'http://localhost:1111/saida-estoque';
                            dadosFormatados = {
                                nome_produto: dados.nome_produto,
                                quantidade: dados.quantidade,
                                setor: dados.setor,
                                data_saida: dados.data,
                                observacao: dados.observacao
                            };
                        }
                        
                        // Enviar para o backend
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(dadosFormatados)
                        });
                        
                        if (!response.ok) {
                            throw new Error(`Erro HTTP: ${response.status}`);
                        }
                        
                        const resultado = await response.json();
                        console.log('Resposta do servidor:', resultado);
                        
                        alert(`✅ ${isDeposit ? 'Entrada' : 'Saída'} registrada com sucesso!`);
                        
                        // Limpar formulário
                        transactionForm.reset();
                        
                        // Restaurar data atual
                        document.getElementById('employee-transaction-date').value = new Date().toISOString().split('T')[0];
                        
                        // Atualizar contadores (se houver função para isso)
                        if (window.carregarDadosEntrada) {
                            carregarDadosEntrada();
                        }
                        
                    } catch (error) {
                        console.error('Erro ao enviar transação:', error);
                        alert(`❌ Erro ao registrar transação: ${error.message}`);
                    } finally {
                        // Restaurar botão
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                    }
                });
            }
        });
    </script>
</body>
</html>