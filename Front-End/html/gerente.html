<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dep√≥sito - Gerente | SLA Sistema de Log√≠stica e Armazenamento</title>
    <link rel="stylesheet" href="../style/deposit.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <header id="main-header" class="manager-mode">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon manager" id="logo-icon">SLA</div>
                    <h1>Sistema de <span>Log√≠stica e Armazenamento</span></h1>
                </div>
                <div class="user-info manager" id="user-info">
                    <span id="user-name">Gerente</span>
                    <span class="user-type manager" id="user-type-display">Gerente</span>
                    <a href="login.html" class="btn btn-danger" id="logout-btn" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                        <i class="fas fa-sign-out-alt"></i>
                        Sair
                    </a>
                </div>
            </div>
        </div>
    </header>

    <section class="page">
        <div class="container">
            <div class="manager-dashboard" id="manager-dashboard">
                <div class="dashboard-header">
                    <div class="welcome-message">
                        <h2 id="welcome-user">Bem-vindo, Gerente!</h2>
                        <p>Painel de Controle Administrativo</p>
                    </div>
                    <div class="pdf-container">
                        <button class="btn btn-pdf" id="generate-pdf-btn">
                            <i class="fas fa-file-pdf"></i>
                            Gerar Relat√≥rio PDF
                        </button>
                    </div>
                </div>

                <div class="manager-controls">
                    <button class="control-btn active" id="btn-relatorios" onclick="switchSection('relatorios')">
                        <i class="fas fa-chart-bar"></i>
                        Relat√≥rio
                    </button>
                </div>

                 <!--HTML dos cards que puxa em tempo real-->
                <div class="employee-section active" id="employee-section-solicitacoes">
                    <div class="employee-metrics">

                    <!-- Solicita√ß√µes Pendentes -->
                <div class="section active" id="section-relatorios">
                    <div class="manager-metrics">
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-icon">
                                    <i class="fas fa-warehouse"></i>
                                </div>
                            </div>
                            <div class="employee-metric-value" id="metric-pendentes"></div>
                            <div class="metric-label">Solicita√ß√µes Pendentes</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-icon">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                            </div>
                            <div class="employee-metric-value" id="metric-concluidas"></div>
                            <div class="metric-label">Solicita√ß√µes Conclu√≠das</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-icon">
                                    <i class="fas fa-box-open"></i>
                                </div>
                            </div>
                            <div class="employee-metric-value" id="card-entrada-material"></div>
                            <div class="metric-label">Entradas Este M√™s</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <div class="employee-metric-value" id="card-saida-material"></div>
                            <div class="metric-label">Sa√≠das Este M√™s</div>
                        </div>
                    </div>
                    
                    <style>
/* APENAS A COR DOS VALORES NUM√âRICOS DOS CARDS */
.employee-metric-value {
    color: #7c3aed !important;
}

/* Se quiser usar o gradiente no texto dos n√∫meros */
.employee-metric-value {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed) !important;
    -webkit-background-clip: text !important;
    background-clip: text !important;
    color: transparent !important;
}

/* Para garantir que tamb√©m pegue os valores no dashboard do gerente */
#metric-pendentes,
#metric-concluidas,
#card-entrada-material, 
#card-saida-material {
    color: #7c3aed !important;
}

/* Ou com gradiente */
#metric-pendentes,
#metric-concluidas,
#card-entrada-material, 
#card-saida-material {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed) !important;
    -webkit-background-clip: text !important;
    background-clip: text !important;
    color: transparent !important;
}
</style>


                    <div class="dashboard-grid">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">Movimenta√ß√µes por Categoria</h3>
                            </div>

                                <iframe 
                                    src="http://localhost:8888/edit/index.html" 
                                    width="100%" 
                                    height="800px" 
                                    title="An√°lise de Dados do Jupyter Notebook"
                                    frameborder="0"
                                    sandbox="allow-scripts allow-same-origin" 
                                >
                                </iframe>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">Status do Estoque</h3>
                            </div>
                            <canvas id="inventoryChart" height="250"></canvas>
                        </div>
                    </div>

                    <div class="card manager-card">
                        <h2 class="card-title manager-title">Relat√≥rio Completo</h2>
                        
                        <table class="advanced-table">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Usu√°rio</th>
                                    <th>Tipo</th>
                                    <th>Material</th>
                                    <th>Quantidade</th>
                                    <th>Valor</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>

                            <tbody id="maintenance-history-body"></tbody>
                        </table>
                    </div>

                    <div class="card manager-card">
                        <h2 class="card-title manager-title">Pendentes</h2>

                        <table class="advanced-table">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Usu√°rio</th>
                                    <th>Tipo</th>
                                    <th>Material</th>
                                    <th>Quantidade</th>
                                    <th>Valor</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>

                            <tbody id="maintenance-pending-body"></tbody>
                        </table>
                    </div>


                </div>
            </div>
        </div>
    </section>

    <script>
        // Fun√ß√£o para verificar autentica√ß√£o - VERS√ÉO FINAL
        function checkAuthentication() {
            const userType = localStorage.getItem('userType');
            const userName = localStorage.getItem('userName');
            const loggedIn = localStorage.getItem('loggedIn');
            
            console.log('=== VERIFICA√á√ÉO DE AUTENTICA√á√ÉO ===');
            console.log('loggedIn:', loggedIn);
            console.log('userType:', userType);
            console.log('userName:', userName);
            console.log('==============================');
            
            // DEBUG: Mostrar todo o localStorage
            console.log('Todo localStorage:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                console.log(`${key}: ${localStorage.getItem(key)}`);
            }
            
            // Verificar se est√° logado
            if (!loggedIn || loggedIn !== 'true') {
                console.log('‚ùå Usu√°rio n√£o est√° logado');
                alert('Sess√£o expirada! Fa√ßa login novamente.');
                window.location.href = 'login.html';
                return false;
            }
            
            // Verificar se √© gerente (manager) OU admin
            const allowedTypes = ['manager', 'admin'];
            if (!allowedTypes.includes(userType)) {
                console.log(`‚ùå Tipo de usu√°rio n√£o permitido: ${userType}`);
                alert('Acesso negado! Esta √°rea √© apenas para gerentes.');
                window.location.href = 'login.html';
                return false;
            }
            
            console.log('‚úÖ Autentica√ß√£o v√°lida!');
            return true;
        }

        // Fun√ß√£o para alternar entre se√ß√µes (mantida para compatibilidade, mas s√≥ tem uma se√ß√£o agora)
        function switchSection(sectionId) {
            // Remover classe active de todos os bot√µes
            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Remover classe active de todas as se√ß√µes
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Adicionar classe active ao bot√£o clicado
            document.getElementById(`btn-${sectionId}`).classList.add('active');
            
            // Adicionar classe active √† se√ß√£o correspondente
            document.getElementById(`section-${sectionId}`).classList.add('active');
        }

        // Fun√ß√£o para gerar gr√°ficos
       async function initializeCharts() {

    // Objeto para armazenar as contagens consolidadas (Ex: {"2025-11": {entradas: 10, saidas: 5}})
    const contagensMensais = {};

    // Fun√ß√£o auxiliar para processar um array de dados
    const processarDados = (dados, tipoMovimentacao, campoData) => {
        
        if (!Array.isArray(dados)) return; // Garante que √© um array
        
        dados.forEach(item => {
            const dataString = item[campoData];
            if (!dataString || dataString.length < 7) return; // Ignora se a data for inv√°lida
            
            // Pega o prefixo AAAA-MM (Ex: "2025-11")
            const mesAno = dataString.substring(0, 7); 

            // Inicializa a contagem para o m√™s/ano
            if (!contagensMensais[mesAno]) {
                contagensMensais[mesAno] = { entradas: 0, saidas: 0 };
            }

            // Incrementa a contagem do tipo espec√≠fico
            contagensMensais[mesAno][tipoMovimentacao]++;
        });
    };

    try {
        // --- 1. BUSCA DE DADOS ---
        const responseEntrada = await fetch("http://localhost:1111/entrada-estoque");
        const dataEntrada = await responseEntrada.json();

        const responseSaida = await fetch("http://localhost:1111/saida-estoque");
        const dataSaida = await responseSaida.json();
        
        // --- 2. PROCESSAMENTO E CONTAGEM ---
        
        // Assumindo chaves de data: 'data_entrada' e 'data_saida'
        processarDados(dataEntrada, 'entradas', 'data_entrada'); 
        processarDados(dataSaida, 'saidas', 'data_saida'); 
        
        // --- 3. PREPARA√á√ÉO DOS DADOS PARA O GR√ÅFICO ---
        
        const mesesAnos = Object.keys(contagensMensais).sort();
        const entradasData = mesesAnos.map(mes => contagensMensais[mes].entradas);
        const saidasData = mesesAnos.map(mes => contagensMensais[mes].saidas);
        
        // Formata os r√≥tulos de "AAAA-MM" para algo mais leg√≠vel, se necess√°rio (Ex: "Nov 2025")
        const labelsFormatadas = mesesAnos.map(mesAno => {
            const [ano, mes] = mesAno.split('-');
            const dataObj = new Date(ano, mes - 1); // mes - 1 pois o m√™s em JS come√ßa em 0
            return dataObj.toLocaleString('pt-BR', { month: 'short', year: 'numeric' });
        });

        // =========================================================================
        // --- LOG/LISTAGEM DOS RESULTADOS (Resposta √† sua solicita√ß√£o) ---
        // =========================================================================
        
        console.log("--- Contagem Mensal de Movimenta√ß√µes ---");
        mesesAnos.forEach(mesAno => {
            const { entradas, saidas } = contagensMensais[mesAno];
            console.log(`M√™s/Ano: ${mesAno} | Entradas: ${entradas} | Sa√≠das: ${saidas}`);
        });
        console.log("---------------------------------------");
        
        // --- 4. ATUALIZA√á√ÉO DO GR√ÅFICO ---
        const inventoryCtx = document.getElementById('inventoryChart');
        if (inventoryCtx) {
            new Chart(inventoryCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    // Substitui os r√≥tulos est√°ticos pelos dados processados
                    labels: labelsFormatadas, 
                    datasets: [{
                        label: 'Entradas',
                        // Substitui os dados est√°ticos pelos dados processados
                        data: entradasData, 
                        backgroundColor: '#10b981',
                        borderColor: '#0da271',
                        borderWidth: 1
                    }, {
                        label: 'Sa√≠das',
                        // Substitui os dados est√°ticos pelos dados processados
                        data: saidasData,
                        backgroundColor: '#ef4444',
                        borderColor: '#dc2626',
                        borderWidth: 1
                    }]
                },
                // ... (Resto das op√ß√µes do gr√°fico) ...
            });
        }

    } catch (error) {
        console.error("Erro ao inicializar gr√°ficos ou buscar dados:", error);
    }
}

        // Configurar logout
        document.getElementById('logout-btn').addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('Deseja realmente sair do sistema?')) {
                localStorage.clear();
                window.location.href = 'login.html';
            }
        });

     // Vers√£o simplificada para gerar PDF
document.getElementById('generate-pdf-btn').addEventListener('click', function() {
    generateSimplePDF();
});

function generateSimplePDF() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // T√≠tulo
        doc.setFontSize(16);
        doc.setTextColor(124, 58, 237);
        doc.text('RELAT√ìRIO DO SISTEMA SLA', 20, 20);
        
        // Data
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 20, 30);
        
        let y = 40;
        
        // TABELA 1: M√©tricas dos Cards do Funcion√°rio
        if (document.querySelector('.employee-metrics')) {
            doc.setFontSize(12);
            doc.setTextColor(124, 58, 237);
            doc.text('1. M√©tricas do Funcion√°rio', 20, y);
            y += 10;
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            
            // Coletar dados
            const pendentes = document.getElementById('metric-pendentes')?.textContent || '0';
            const concluidas = document.getElementById('metric-concluidas')?.textContent || '0';
            const entradas = document.getElementById('card-entrada-material')?.textContent || '0';
            const saidas = document.getElementById('card-saida-material')?.textContent || '0';
            
            doc.text(`Solicita√ß√µes Pendentes: ${pendentes}`, 25, y);
            y += 7;
            doc.text(`Solicita√ß√µes Conclu√≠das: ${concluidas}`, 25, y);
            y += 7;
            doc.text(`Entradas do M√™s: ${entradas}`, 25, y);
            y += 7;
            doc.text(`Sa√≠das do M√™s: ${saidas}`, 25, y);
            y += 15;
        }
        
        // TABELA 2: Solicita√ß√µes de Material
        if (document.querySelector('#employee-section-solicitacoes table')) {
            if (y > 250) { doc.addPage(); y = 20; }
            
            doc.setFontSize(12);
            doc.setTextColor(124, 58, 237);
            doc.text('2. Solicita√ß√µes de Material', 20, y);
            y += 10;
            
            const tabela = document.querySelector('#employee-section-solicitacoes table');
            if (tabela) {
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
                
                const linhas = tabela.querySelectorAll('tbody tr');
                linhas.forEach((linha, index) => {
                    if (y > 270) { doc.addPage(); y = 20; }
                    
                    const cells = linha.querySelectorAll('td');
                    if (cells.length >= 6) {
                        const texto = `${cells[0].textContent} | ${cells[2].textContent} | ${cells[3].textContent} | ${cells[5].textContent}`;
                        doc.text(texto, 25, y);
                        y += 8;
                    }
                });
                y += 10;
            }
        }
        
        // TABELA 3: Movimenta√ß√µes
        if (document.querySelectorAll('#employee-section-movimentacao table')[1]) {
            if (y > 250) { doc.addPage(); y = 20; }
            
            doc.setFontSize(12);
            doc.setTextColor(124, 58, 237);
            doc.text('3. Movimenta√ß√µes Recentes', 20, y);
            y += 10;
            
            const tabela = document.querySelectorAll('#employee-section-movimentacao table')[1];
            if (tabela) {
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
                
                const linhas = tabela.querySelectorAll('tbody tr');
                linhas.forEach((linha) => {
                    if (y > 270) { doc.addPage(); y = 20; }
                    
                    const cells = linha.querySelectorAll('td');
                    if (cells.length >= 5) {
                        const texto = `${cells[0].textContent} | ${cells[2].textContent} | ${cells[3].textContent}`;
                        doc.text(texto, 25, y);
                        y += 8;
                    }
                });
                y += 10;
            }
        }
        
        // TABELA 4: Manuten√ß√µes do Sistema de Manuten√ß√£o
        if (document.querySelector('#maintenance-dashboard')) {
            if (y > 250) { doc.addPage(); y = 20; }
            
            doc.setFontSize(12);
            doc.setTextColor(124, 58, 237);
            doc.text('4. Sistema de Manuten√ß√£o', 20, y);
            y += 10;
            
            // M√©tricas de manuten√ß√£o
            const pendentesManut = document.getElementById('manutencao-pendente')?.textContent || '0';
            const concluidasManut = document.getElementById('manutencao-concluida')?.textContent || '0';
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text(`Manuten√ß√µes Pendentes: ${pendentesManut}`, 25, y);
            y += 7;
            doc.text(`Manuten√ß√µes Conclu√≠das: ${concluidasManut}`, 25, y);
            y += 15;
            
            // Hist√≥rico de manuten√ß√µes
            if (document.querySelector('#maintenance-history-body')) {
                doc.setFontSize(11);
                doc.setTextColor(124, 58, 237);
                doc.text('Hist√≥rico de Manuten√ß√µes:', 20, y);
                y += 10;
                
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
                
                const tbody = document.querySelector('#maintenance-history-body');
                const linhas = tbody.querySelectorAll('tr');
                
                if (linhas.length === 0) {
                    doc.text('Nenhuma manuten√ß√£o conclu√≠da', 25, y);
                    y += 8;
                } else {
                    linhas.forEach((linha) => {
                        if (y > 270) { doc.addPage(); y = 20; }
                        
                        const cells = linha.querySelectorAll('td');
                        if (cells.length >= 7) {
                            const texto = `ID: ${cells[0].textContent} | ${cells[1].textContent} | ${cells[6].textContent}`;
                            doc.text(texto, 25, y);
                            y += 8;
                        }
                    });
                }
                y += 10;
            }
            
            // Manuten√ß√µes pendentes
            if (document.querySelector('#maintenance-pending-body')) {
                if (y > 250) { doc.addPage(); y = 20; }
                
                doc.setFontSize(11);
                doc.setTextColor(124, 58, 237);
                doc.text('Manuten√ß√µes Pendentes:', 20, y);
                y += 10;
                
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
                
                const tbody = document.querySelector('#maintenance-pending-body');
                const linhas = tbody.querySelectorAll('tr');
                
                if (linhas.length === 0) {
                    doc.text('Nenhuma manuten√ß√£o pendente', 25, y);
                    y += 8;
                } else {
                    linhas.forEach((linha) => {
                        if (y > 270) { doc.addPage(); y = 20; }
                        
                        const cells = linha.querySelectorAll('td');
                        if (cells.length >= 7) {
                            const texto = `ID: ${cells[0].textContent} | ${cells[1].textContent} | ${cells[6].textContent}`;
                            doc.text(texto, 25, y);
                            y += 8;
                        }
                    });
                }
            }
        }
        
        // Rodap√©
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text('Sistema SLA - Relat√≥rio gerado automaticamente', 105, 285, null, null, 'center');
        
        // Salvar PDF
        const fileName = `relatorio_sla_${new Date().toISOString().slice(0, 10)}.pdf`;
        doc.save(fileName);
        
        // Mensagem simples
        alert('‚úÖ PDF gerado com sucesso!');
        
    } catch (error) {
        console.error('Erro:', error);
        alert('‚ùå Erro ao gerar PDF');
    }
}

// Fun√ß√µes auxiliares simples (opcional)
function getStatusPendentes(valor) {
    const num = parseInt(valor);
    if (num === 0) return '‚úÖ OK';
    if (num < 5) return '‚ö†Ô∏è Baixo';
    return 'üî¥ Alto';
}

function getStatusConcluidas(valor) {
    const num = parseInt(valor);
    if (num === 0) return '‚ùå Nenhuma';
    if (num < 5) return '‚ö†Ô∏è Poucas';
    return '‚úÖ Bom';
}

        // Inicializar quando o DOM carregar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìã P√°gina do gerente carregada');
            
            // Primeiro verificar autentica√ß√£o
            const isAuthenticated = checkAuthentication();
            
            if (isAuthenticated) {
                // Atualizar nome do usu√°rio se existir
                const userName = localStorage.getItem('userName');
                if (userName) {
                    document.getElementById('user-name').textContent = userName;
                    document.getElementById('welcome-user').textContent = `Bem-vindo, ${userName}!`;
                }
                
                // Mostrar dashboard
                document.getElementById('manager-dashboard').style.display = 'block';
                
                // Inicializar gr√°ficos
                initializeCharts();
                
                console.log('‚úÖ Dashboard do gerente inicializado com sucesso!');
            }
        });

async function carregarSolicitacoes() {
    try {
        const response = await fetch("http://localhost:1111/solicitacoes");
        const solicitacoes = await response.json();
        atualizarTabelas(solicitacoes);

    } catch (error) {
        console.error("Erro ao carregar dados do backend:", error);
    }
}

function atualizarTabelas(solicitacoes) {
    const tbody1 = document.getElementById("maintenance-history-body");
    const tbody2 = document.getElementById("maintenance-pending-body");

    if (tbody1) tbody1.innerHTML = "";
    if (tbody2) tbody2.innerHTML = "";

    const concluidas = solicitacoes.filter(s => s.status === "CONCLUIDA");
    const pendentes  = solicitacoes.filter(s => s.status === "PENDENTE");

    // --- Tabela conclu√≠das ---
    if (tbody1) {
        concluidas.forEach(s => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${s.data_hora}</td>
                <td>${s.usuario}</td>
                <td>${s.tipo}</td>
                <td>${s.material}</td>
                <td>${s.quantidade}</td>
                <td>${s.valor}</td>
                <td><span class="status-badge status-low">${s.status}</span></td>
                <td><button class="btn-ver">Ver</button></td>
            `;
            tbody1.appendChild(row);
        });
    }

    // --- Tabela pendentes ---
    if (tbody2) {
        pendentes.forEach(s => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${s.data_hora}</td>
                <td>${s.usuario}</td>
                <td>${s.tipo}</td>
                <td>${s.material}</td>
                <td>${s.quantidade}</td>
                <td>${s.valor}</td>
                <td><span class="status-badge status-warning">${s.status}</span></td>
                <td><button class="btn-aprovar">Aprovar</button></td>
            `;
            tbody2.appendChild(row);
        });
    }
}

// Atualiza ao carregar a p√°gina
carregarSolicitacoes();


    </script>
        <script src="../../Back-End/back/deposit.js"></script>
</body>
</html>